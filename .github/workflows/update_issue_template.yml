name: Update Issue Template with Release Tags

on:
  schedule:
    - cron: '0 0 * * *' # Runs daily at midnight
  workflow_dispatch:

jobs:
  update-template:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
      
      - name: Fetch the latest 5 release tags from another repository
        id: get-tags
        uses: actions/github-script@v6
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            const tags = await github.rest.repos.listTags({
              owner: 'erusev',
              repo: 'parsedown',
              per_page: 5
            });
            return tags.data.map(tag => tag.name).join('\n');

      - name: Update issue template with tags
        run: |
          TEMPLATE_PATH=".github/ISSUE_TEMPLATE/bug_report.yml"
          # Read in the tags as a Bash array
          IFS=$'\n' read -r -d '' -a tags <<<"${{ steps.get-tags.outputs.result }}"
          # Start constructing the replacement YAML snippet
          yaml_snippet="        - Homebrew\n        - MacPorts\n        - apt-get\n        - Built from source"
          for tag in "${tags[@]}"; do
            yaml_snippet="$yaml_snippet\n        - $tag"
          done
          # Use awk to replace the options section of the dropdown
          awk -v rs="$yaml_snippet" '
            BEGIN {p=1}
            /id: download/ {print; getline; print; p=0}
            /options:/,/validations:/{if(p==0 && /- /)next}
            /validations:/{p=1}
            {print}
          ' $TEMPLATE_PATH > temp && mv temp $TEMPLATE_PATH

      - name: Commit and push if changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add $TEMPLATE_PATH
          git diff --staged --quiet || git commit -m "Update issue template with latest release tags"
          git push
