name: Update Issue Template with Release Tags

on:
  schedule:
    - cron: '0 0 * * *' # Runs daily at midnight
  workflow_dispatch:

jobs:
  update-template:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Fetch the latest 5 release tags
        id: get-tags
        uses: actions/github-script@v6
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            const tags = await github.rest.repos.listTags({
              owner: 'erusev',
              repo: 'parsedown',
              per_page: 5
            });
            return tags.data.map(tag => tag.name);

      - name: Update issue template with tags
        run: |
          TEMPLATE_PATH=".github/ISSUE_TEMPLATE/bug_report.yml"
          # Prepare the versions section
          VERSIONS_SECTION=$(echo "${{ join(steps.get-tags.outputs.result) }}" | sed -e "s/ /\\n        - label: /g" | sed -e "s/^/        - label: /")
          # Escape slashes for sed
          VERSIONS_SECTION_ESCAPED=$(echo "$VERSIONS_SECTION" | sed -e 's_/_\\/_g')
          # Replace the versions section in the YAML file
          sed -i "/      label: Affected Versions/,/    validations:/ {
            /      options:/, /    validations:/ {
              /      options:/b
              /    validations:/b
              /- label:/d
            }
          }" $TEMPLATE_PATH
          sed -i "/      options:/ a \\\n$VERSIONS_SECTION_ESCAPED" $TEMPLATE_PATH

      - name: Commit and push if changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add $TEMPLATE_PATH
          git diff --staged --quiet || git commit -m "Update issue template with latest release tags"
          git push
